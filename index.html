<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>NEXUS VTT // ORDO REALITAS ULTRA</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --neon: #00f2ff; --red: #ff3e3e; --yellow: #f1c40f; 
            --bg-dark: #050506; --panel: rgba(15, 15, 18, 0.95);
            --border: rgba(0, 242, 255, 0.3);
        }

        * { box-sizing: border-box; scrollbar-width: thin; scrollbar-color: var(--neon) transparent; }
        body { 
            margin: 0; background: var(--bg-dark); color: #e0e0e0; 
            font-family: 'Rajdhani', sans-serif; display: flex; height: 100vh; overflow: hidden; 
        }

        /* --- PAINEL LATERAL (UI) --- */
        #sidebar { 
            width: 340px; background: var(--panel); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 1000; backdrop-filter: blur(10px);
            box-shadow: 10px 0 30px rgba(0,0,0,0.5); padding: 20px;
        }

        .brand { font-family: 'Orbitron'; font-size: 18px; color: var(--neon); letter-spacing: 3px; margin-bottom: 25px; text-shadow: 0 0 10px var(--neon); }
        .section-title { font-family: 'Orbitron'; font-size: 10px; color: #666; text-transform: uppercase; letter-spacing: 2px; margin: 20px 0 10px 0; border-bottom: 1px solid #222; padding-bottom: 5px; }

        /* --- BOT√ïES ESTILIZADOS --- */
        .btn {
            background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: #fff;
            padding: 10px; width: 100%; cursor: pointer; font-family: 'Orbitron'; font-size: 9px;
            margin-bottom: 8px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase; clip-path: polygon(5% 0, 100% 0, 100% 70%, 95% 100%, 0 100%, 0% 30%);
        }
        .btn:hover { background: var(--neon); color: #000; border-color: #fff; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 242, 255, 0.4); }
        .btn-danger { border-color: var(--red); color: var(--red); }
        .btn-danger:hover { background: var(--red); color: #fff; box-shadow: 0 5px 15px rgba(255, 62, 62, 0.4); }

        /* --- √ÅREA DO MAPA --- */
        #viewport { flex: 1; position: relative; background: radial-gradient(circle, #1a1a1c 0%, #050506 100%); overflow: auto; display: flex; justify-content: center; align-items: center; }
        #map-container { position: relative; box-shadow: 0 0 50px rgba(0,0,0,1); }
        #main-map { display: block; max-width: none; }

        /* --- TOKENS --- */
        .token { position: absolute; z-index: 100; cursor: move; display: flex; flex-direction: column; align-items: center; user-select: none; }
        .tk-art { 
            width: 70px; height: 70px; border: 2px solid var(--neon); border-radius: 50%;
            background-size: cover; background-position: center; background-color: #111;
            transition: transform 0.2s, filter 0.3s; box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        .selected .tk-art { border-color: #fff; box-shadow: 0 0 20px var(--neon); transform: scale(1.05); }

        /* ESTADOS */
        .state-injured { border-color: var(--red) !important; animation: pulse 1.5s infinite; }
        .state-dead { filter: grayscale(1) brightness(0.4); }
        .state-dead::after { content: '‚úï'; position: absolute; color: var(--red); font-size: 40px; top: 15%; }

        @keyframes pulse { 0% { box-shadow: 0 0 0px var(--red); } 50% { box-shadow: 0 0 20px var(--red); } 100% { box-shadow: 0 0 0px var(--red); } }

        /* PISTAS */
        .token.pista .tk-art { border-radius: 4px; border-color: var(--yellow); border-style: solid; width: 60px; height: 80px; }

        /* SOMBRAS */
        .fog { position: absolute; background: rgba(0,0,0,0.95); border: 1px dashed rgba(255,255,255,0.1); z-index: 500; cursor: move; transition: opacity 0.3s; }
        .fog:hover { border-color: var(--neon); }
        .fog.selected { border: 2px solid var(--neon); background: rgba(0,0,0,0.8); }

        /* --- CONTROLES DE EDI√á√ÉO --- */
        .edit-panel { background: rgba(255,255,255,0.03); border: 1px solid #222; padding: 15px; border-radius: 4px; display: none; margin-top: 10px; }
        label { font-size: 9px; color: #888; text-transform: uppercase; margin-top: 10px; display: block; }
        input, select { 
            width: 100%; background: #000; border: 1px solid #333; color: #fff; 
            padding: 8px; margin-top: 4px; font-family: 'Rajdhani'; font-weight: bold;
        }
        input[type="range"] { accent-color: var(--neon); }
        
        .stat-group { display: flex; gap: 5px; }

        /* BARRA DE VIDA */
        .tk-ui { width: 100%; text-align: center; margin-top: 5px; }
        .tk-name { font-family: 'Orbitron'; font-size: 10px; color: #fff; text-shadow: 1px 1px 2px #000; margin-bottom: 3px; }
        .hp-container { height: 4px; background: #000; border: 1px solid #222; width: 100%; border-radius: 2px; overflow: hidden; }
        .hp-bar { height: 100%; background: var(--red); width: 100%; transition: width 0.4s ease-out; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="brand">NEXUS // CORE</div>
    
    <button class="btn" onclick="document.getElementById('map-input').click()">üìÅ Carregar Mapa</button>
    <input type="file" id="map-input" style="display:none" onchange="uploadMap(this)">
    
    <div class="section-title">Comandos de Campo</div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
        <button class="btn" onclick="addToken('hero')">üë§ Her√≥i</button>
        <button class="btn" onclick="addToken('pista')">üìÑ Pista</button>
    </div>
    <button class="btn" onclick="addFog()">üåë Nova Sombra</button>

    <div id="edit-panel" class="edit-panel">
        <h3 id="edit-label" style="font-family:'Orbitron'; font-size:10px; margin:0 0 10px 0; color:var(--neon)">CONFIGURA√á√ÉO</h3>
        
        <label>Identifica√ß√£o:</label>
        <input type="text" id="edit-name" oninput="applyChanges()">
        
        <div id="hero-stats">
            <label>Integridade F√≠sica (Atual/M√°x):</label>
            <div class="stat-group">
                <input type="number" id="edit-hp-cur" oninput="applyChanges()">
                <input type="number" id="edit-hp-max" oninput="applyChanges()">
            </div>
            <label>Estado Vital:</label>
            <select id="edit-state" onchange="applyChanges()">
                <option value="normal">ATIVO</option>
                <option value="injured">MORRENDO (PULSO)</option>
                <option value="dead">K.O. / MORTO</option>
            </select>
        </div>

        <div id="dim-controls">
            <label>Escala Global:</label>
            <input type="range" id="edit-scale" min="30" max="1000" oninput="applyChanges()">
            <div id="fog-only" style="display:none">
                <label>Altura:</label>
                <input type="range" id="edit-h" min="20" max="1000" oninput="applyChanges()">
            </div>
        </div>

        <button class="btn" style="margin-top:15px;" onclick="document.getElementById('img-input').click()">üì∑ Alterar Imagem</button>
        <input type="file" id="img-input" style="display:none" onchange="uploadArt(this)">
        
        <button class="btn btn-danger" onclick="deleteTarget()">üóëÔ∏è Eliminar</button>
    </div>

    <div class="section-title">Terminal de Dados</div>
    <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:5px;">
        <button class="btn" onclick="roll(20)">D20</button>
        <button class="btn" onclick="roll(10)">D10</button>
        <button class="btn" onclick="roll(6)">D6</button>
    </div>
    <div id="dice-log" style="font-size:11px; color:#555; margin-top:10px; height:100px; overflow-y:auto; font-family:monospace; background:rgba(0,0,0,0.2); padding:5px;"></div>
</div>

<div id="viewport">
    <div id="map-container">
        <img id="main-map" src="">
    </div>
</div>

<script>
    let currentTarget = null;
    let zIndexCounter = 100;

    function uploadMap(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => document.getElementById('main-map').src = e.target.result;
            reader.readAsDataURL(input.files[0]);
        }
    }

    function addToken(type) {
        const t = document.createElement('div');
        t.className = `token ${type}`;
        t.style.left = '100px'; t.style.top = '100px'; t.style.zIndex = zIndexCounter++;
        
        t.innerHTML = `
            <div class="tk-ui"><div class="tk-name">Novo ${type}</div></div>
            <div class="tk-art"></div>
            <div class="tk-ui hp-ui">
                <div style="font-size:9px; color:var(--neon); margin-top:2px;" class="hp-txt">20/20</div>
                <div class="hp-container"><div class="hp-bar"></div></div>
            </div>`;

        t.dataset.type = type;
        t.dataset.scale = type === 'pista' ? 120 : 75;
        t.dataset.h = 100;
        t.dataset.hpCur = 20;
        t.dataset.hpMax = 20;
        t.dataset.state = 'normal';

        initDrag(t);
        document.getElementById('map-container').appendChild(t);
        t.dispatchEvent(new Event('mousedown'));
    }

    function addFog() {
        const f = document.createElement('div');
        f.className = 'fog';
        f.style.width = '200px'; f.style.height = '200px';
        f.style.left = '50px'; f.style.top = '50px'; f.style.zIndex = 500;
        f.dataset.type = 'fog';
        initDrag(f);
        document.getElementById('map-container').appendChild(f);
        f.dispatchEvent(new Event('mousedown'));
    }

    function initDrag(el) {
        el.onmousedown = function(e) {
            if (e.button !== 0) return;
            selectTarget(el);
            let shiftX = e.clientX - el.getBoundingClientRect().left;
            let shiftY = e.clientY - el.getBoundingClientRect().top;

            function moveAt(pageX, pageY) {
                const map = document.getElementById('map-container').getBoundingClientRect();
                el.style.left = (pageX - map.left - shiftX) + 'px';
                el.style.top = (pageY - map.top - shiftY) + 'px';
            }

            function onMouseMove(e) { moveAt(e.pageX, e.pageY); }
            document.addEventListener('mousemove', onMouseMove);
            document.onmouseup = () => {
                document.removeEventListener('mousemove', onMouseMove);
                document.onmouseup = null;
            };
        };
    }

    function selectTarget(el) {
        currentTarget = el;
        document.querySelectorAll('.token, .fog').forEach(x => x.classList.remove('selected'));
        el.classList.add('selected');
        el.style.zIndex = zIndexCounter++;

        const isFog = el.dataset.type === 'fog';
        document.getElementById('edit-panel').style.display = 'block';
        document.getElementById('hero-stats').style.display = (el.dataset.type === 'hero') ? 'block' : 'none';
        document.getElementById('fog-only').style.display = isFog ? 'block' : 'none';
        
        if (!isFog) {
            document.getElementById('edit-name').value = el.querySelector('.tk-name').innerText;
            document.getElementById('edit-hp-cur').value = el.dataset.hpCur;
            document.getElementById('edit-hp-max').value = el.dataset.hpMax;
            document.getElementById('edit-state').value = el.dataset.state;
            document.getElementById('edit-scale').value = el.dataset.scale;
        } else {
            document.getElementById('edit-name').value = "√Årea de Sombra";
            document.getElementById('edit-scale').value = parseInt(el.style.width);
            document.getElementById('edit-h').value = parseInt(el.style.height);
        }
    }

    function applyChanges() {
        if (!currentTarget) return;
        const isFog = currentTarget.dataset.type === 'fog';

        if (isFog) {
            currentTarget.style.width = document.getElementById('edit-scale').value + 'px';
            currentTarget.style.height = document.getElementById('edit-h').value + 'px';
        } else {
            const s = document.getElementById('edit-scale').value;
            currentTarget.dataset.scale = s;
            currentTarget.dataset.hpCur = document.getElementById('edit-hp-cur').value;
            currentTarget.dataset.hpMax = document.getElementById('edit-hp-max').value;
            currentTarget.dataset.state = document.getElementById('edit-state').value;

            const art = currentTarget.querySelector('.tk-art');
            art.style.width = s + 'px';
            art.style.height = (currentTarget.dataset.type === 'pista' ? s * 1.4 : s) + 'px';
            
            currentTarget.querySelector('.tk-name').innerText = document.getElementById('edit-name').value;
            art.className = `tk-art state-${currentTarget.dataset.state}`;

            if (currentTarget.dataset.type === 'hero') {
                const pct = (currentTarget.dataset.hpCur / currentTarget.dataset.hpMax) * 100;
                currentTarget.querySelector('.hp-bar').style.width = pct + '%';
                currentTarget.querySelector('.hp-txt').innerText = `${currentTarget.dataset.hpCur}/${currentTarget.dataset.hpMax}`;
            }
        }
    }

    function uploadArt(input) {
        if (input.files && input.files[0] && currentTarget) {
            const reader = new FileReader();
            reader.onload = e => {
                if(currentTarget.querySelector('.tk-art'))
                    currentTarget.querySelector('.tk-art').style.backgroundImage = `url(${e.target.result})`;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function deleteTarget() {
        if (currentTarget) {
            currentTarget.remove();
            currentTarget = null;
            document.getElementById('edit-panel').style.display = 'none';
        }
    }

    function roll(f) {
        const v = Math.floor(Math.random() * f) + 1;
        const log = document.getElementById('dice-log');
        log.innerHTML = `<div>> <span style="color:var(--neon)">d${f}:</span> <b>${v}</b></div>` + log.innerHTML;
    }
</script>

</body>
</html>
