<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS VTT // ORDEAL RPG</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --neon: #00f2ff; --accent: #7000ff; --bg: #02050a; --card: #0d1117; --red: #ff3e3e; }
        * { box-sizing: border-box; }
        body { background: var(--bg); color: #fff; font-family: 'Rajdhani', sans-serif; margin: 0; height: 100vh; display: grid; grid-template-columns: 320px 1fr 280px; overflow: hidden; }

        header { grid-column: 1 / -1; background: #000; border-bottom: 1px solid var(--neon); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 1000; }
        h1 { font-family: 'Orbitron'; font-size: 18px; margin: 0; color: var(--neon); letter-spacing: 2px; }
        
        aside, main { height: calc(100vh - 50px); overflow-y: auto; padding: 15px; border-right: 1px solid rgba(0,242,255,0.1); }

        /* Ficha */
        .stat-card { background: var(--card); border: 1px solid #333; padding: 10px; border-radius: 5px; text-align: center; }
        .stat-card label { font-size: 10px; color: var(--neon); display: block; font-family: 'Orbitron'; }
        .stat-card input { background: transparent; border: none; color: #fff; font-size: 20px; width: 100%; text-align: center; font-weight: bold; }
        
        .resource-bar { background: #1a1a1a; border-radius: 3px; height: 8px; margin-top: 5px; overflow: hidden; }
        .bar-fill { height: 100%; transition: 0.3s; }

        .skill-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; background: rgba(255,255,255,0.03); padding: 5px 8px; border-radius: 4px; font-size: 13px; }
        .skill-row input { width: 40px; background: none; border: none; color: var(--neon); text-align: right; font-weight: bold; }

        /* Mapa e Tokens */
        #viewport { background: #000; position: relative; overflow: hidden; padding: 0; display: flex; justify-content: center; align-items: center; }
        #map-container { position: relative; display: inline-block; line-height: 0; }
        #map-img { max-width: 100vw; max-height: 100vh; pointer-events: none; }
        #fog { position: absolute; top:0; left:0; z-index: 10; cursor: crosshair; }
        
        .token { 
            position: absolute; width: 60px; height: 60px; border: 2px solid var(--neon); 
            border-radius: 50%; background-size: cover; z-index: 20; cursor: move; 
            box-shadow: 0 0 10px #000; touch-action: none;
        }

        /* Log */
        .log-box { background: #000; border: 1px solid #222; height: 350px; overflow-y: auto; padding: 10px; font-family: monospace; font-size: 12px; color: #aaa; margin-bottom: 15px; border-radius: 5px; }
        .action-btn { background: var(--accent); color: #fff; border: none; padding: 10px; width: 100%; border-radius: 5px; font-family: 'Orbitron'; font-size: 10px; cursor: pointer; margin-bottom: 8px; }
    </style>
</head>
<body>

<header>
    <h1>NEXUS VTT // CORE</h1>
    <div id="player-name" contenteditable="true" style="color:var(--neon); border-bottom:1px solid #333;">NOME DO PERSONAGEM</div>
</header>

<aside>
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
        <div class="stat-card"><label>CORPO</label><input type="number" id="attr-corpo" value="5" onchange="updateResources()"></div>
        <div class="stat-card"><label>MENTE</label><input type="number" id="attr-mente" value="3" onchange="updateResources()"></div>
        <div class="stat-card"><label>ALMA</label><input type="number" id="attr-alma" value="2" onchange="updateResources()"></div>
    </div>

    <div style="margin-bottom:20px; background:var(--card); padding:10px; border-radius:5px;">
        <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px;">
            <span>PV: <b id="pv-val">15/15</b></span>
            <span>MANA: <b id="mana-val">4/4</b></span>
            <span>DEF: <b id="def-val">12</b></span>
        </div>
        <div class="resource-bar"><div id="pv-bar" class="bar-fill" style="width:100%; background:var(--red);"></div></div>
        <div class="resource-bar"><div id="mana-bar" class="bar-fill" style="width:100%; background:var(--neon);"></div></div>
    </div>

    <div id="skills-area">
        <h3 style="font-family:'Orbitron'; font-size:11px; color:var(--accent);">PER√çCIAS</h3>
        <div id="skills-list"></div>
    </div>
</aside>

<main id="viewport">
    <div id="map-container">
        <img id="map-img" src="">
        <canvas id="fog"></canvas>
    </div>
</main>

<aside style="border-left:1px solid rgba(0,242,255,0.1);">
    <h3 style="font-family:'Orbitron'; font-size:11px; color:var(--neon);">COMANDOS</h3>
    <div id="log" class="log-box"></div>

    <button class="action-btn" onclick="document.getElementById('map-upload').click()">üñºÔ∏è CARREGAR MAPA</button>
    <input type="file" id="map-upload" style="display:none" accept="image/*">
    
    <button class="action-btn" style="background:#222;" onclick="resetFog()">‚òÅÔ∏è RESET N√âVOA</button>
    <button class="action-btn" style="background:var(--neon); color:#000;" onclick="addToken()">üë§ GERAR TOKEN</button>
    
    <div style="margin-top:15px; font-size:10px; color:#555;">
        DICA: Clique no d20 da per√≠cia para rolar. Arraste no mapa para revelar.
    </div>
</aside>

<script>
    const log = document.getElementById('log');
    const canvas = document.getElementById('fog');
    const ctx = canvas.getContext('2d');
    const mapImg = document.getElementById('map-img');

    const skillsOrdeal = [
        {n: "Luta", a: "corpo"}, {n: "Pontaria", a: "corpo"}, {n: "Acrobacia", a: "corpo"}, 
        {n: "Atletismo", a: "corpo"}, {n: "Furtividade", a: "corpo"},
        {n: "Investiga√ß√£o", a: "mente"}, {n: "Medicina", a: "mente"}, {n: "Persuas√£o", a: "mente"},
        {n: "Manifesta√ß√£o", a: "alma"}, {n: "Percep√ß√£o", a: "alma"}, {n: "Vontade", a: "alma"}
    ];

    function init() {
        const container = document.getElementById('skills-list');
        skillsOrdeal.forEach(s => {
            container.innerHTML += `
                <div class="skill-row">
                    <span>${s.n}</span>
                    <div>
                        <input type="number" value="0" id="skill-${s.n}" onchange="updateResources()">
                        <button onclick="roll('${s.n}')" style="background:none; border:1px solid var(--neon); color:var(--neon); cursor:pointer; font-size:9px; margin-left:5px;">d20</button>
                    </div>
                </div>`;
        });
        updateResources();
    }

    function updateResources() {
        const c = parseInt(document.getElementById('attr-corpo').value) || 0;
        const a = parseInt(document.getElementById('attr-alma').value) || 0;
        const acrobacia = parseInt(document.getElementById('skill-Acrobacia').value) || 0;

        const maxPV = c + 10;
        const maxMana = a * 2;
        const def = 10 + Math.floor(c/2) + acrobacia;

        document.getElementById('pv-val').innerText = `${maxPV}/${maxPV}`;
        document.getElementById('mana-val').innerText = `${maxMana}/${maxMana}`;
        document.getElementById('def-val').innerText = def;
    }

    function roll(name) {
        const bonus = parseInt(document.getElementById(`skill-${name}`).value) || 0;
        const d20 = Math.floor(Math.random() * 20) + 1;
        const total = d20 + bonus;
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        let style = d20 === 20 ? "color:var(--neon); font-weight:bold;" : (d20 === 1 ? "color:red;" : "");
        log.innerHTML = `<div class="log-entry">[${time}] <b>${name}</b><br><span style="${style}">üé≤ ${d20} + ${bonus} = ${total}</span></div>` + log.innerHTML;
    }

    // Mapa
    document.getElementById('map-upload').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
            mapImg.src = ev.target.result;
            mapImg.onload = () => {
                canvas.width = mapImg.clientWidth;
                canvas.height = mapImg.clientHeight;
                resetFog();
            };
        };
        reader.readAsDataURL(e.target.files[0]);
    };

    function resetFog() {
        ctx.globalCompositeOperation = 'source-over';
        ctx.fillStyle = "#050b14";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    // Revelar N√©voa
    let drawing = false;
    canvas.onmousedown = () => drawing = true;
    window.onmouseup = () => drawing = false;
    canvas.onmousemove = (e) => {
        if(!drawing) return;
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left) * (canvas.width / rect.width);
        const y = (e.clientY - rect.top) * (canvas.height / rect.height);
        ctx.globalCompositeOperation = 'destination-out';
        ctx.beginPath(); ctx.arc(x, y, 40, 0, Math.PI*2); ctx.fill();
    }

    // Tokens
    function addToken() {
        const t = document.createElement('div');
        t.className = 'token';
        t.style.left = "50px"; t.style.top = "50px";
        t.style.backgroundColor = "rgba(0,242,255,0.2)";
        
        t.onmousedown = function(e) {
            if(e.button !== 0) return;
            let shiftX = e.clientX - t.getBoundingClientRect().left;
            let shiftY = e.clientY - t.getBoundingClientRect().top;
            function moveAt(pageX, pageY) {
                const rect = document.getElementById('map-container').getBoundingClientRect();
                t.style.left = (pageX - rect.left - shiftX) + 'px';
                t.style.top = (pageY - rect.top - shiftY) + 'px';
            }
            function onMouseMove(ev) { moveAt(ev.pageX, ev.pageY); }
            document.addEventListener('mousemove', onMouseMove);
            t.onmouseup = () => document.removeEventListener('mousemove', onMouseMove);
        };
        t.ondragstart = () => false;
        t.oncontextmenu = (e) => { e.preventDefault(); t.remove(); };
        document.getElementById('map-container').appendChild(t);
    }

    init();
</script>
</body>
</html>
