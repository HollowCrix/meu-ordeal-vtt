<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>NEXUS VTT // REFINED V15</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Quicksand:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #c8a032; --wine: #5a0000; --bg: #0a0a0c; --panel: #141417; }
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        body { background: var(--bg); color: #e0e0e0; font-family: 'Quicksand', sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* BARRA DE CENAS */
        #scene-bar { height: 50px; background: #000; border-bottom: 2px solid var(--wine); display: flex; align-items: center; padding: 0 15px; gap: 10px; z-index: 2000; }
        .scene-btn { background: #1a1a1a; border: 1px solid #333; color: #888; padding: 6px 15px; font-family: 'Cinzel'; font-size: 11px; cursor: pointer; border-radius: 4px; }
        .scene-btn.active { border-color: var(--gold); color: var(--gold); background: var(--wine); }
        .add-scene { color: var(--gold); font-size: 24px; cursor: pointer; padding: 0 10px; }

        #main { display: flex; flex: 1; overflow: hidden; }

        /* SIDEBAR */
        #sidebar { width: 310px; background: var(--panel); border-right: 1px solid #222; padding: 20px; z-index: 1500; overflow-y: auto; }
        .brand { font-family: 'Cinzel'; font-size: 18px; color: var(--gold); text-align: center; margin-bottom: 20px; letter-spacing: 2px; border-bottom: 1px solid #333; padding-bottom: 10px; }

        /* VIEWPORT */
        #viewport { flex: 1; position: relative; background: #050505; cursor: grab; overflow: hidden; }
        .world-layer { position: absolute; transform-origin: 0 0; display: none; pointer-events: none; }
        .world-layer.active { display: block; pointer-events: auto; }

        /* TOKENS E SOMBRAS */
        .token, .fog { position: absolute; cursor: move; display: flex; flex-direction: column; align-items: center; pointer-events: all; }
        .tk-art { background-size: contain; background-repeat: no-repeat; background-position: center bottom; position: relative; transition: filter 0.3s; }
        
        /* ESTADOS VISUAIS */
        .selected .tk-art { filter: drop-shadow(0 0 12px var(--gold)) !important; }
        
        /* Estado Morto */
        .state-dead { filter: grayscale(1) brightness(0.2) !important; }
        .state-dead::after { content: '✕'; position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); color: #ff0000; font-size: 50px; text-shadow: 0 0 10px #000; filter: none !important; }
        
        /* Estado Ferido */
        .state-injured { animation: pulseRed 1.2s infinite ease-in-out; }
        @keyframes pulseRed { 0%, 100% { filter: drop-shadow(0 0 3px var(--wine)); } 50% { filter: drop-shadow(0 0 18px #ff2222); } }

        /* UI INTERNA DO TOKEN */
        .hp-bar { width: 100%; height: 6px; background: #000; border: 1px solid #333; border-radius: 3px; margin-bottom: 4px; overflow: hidden; }
        .hp-fill { height: 100%; background: linear-gradient(90deg, #600, #b00); transition: width 0.3s; }
        .tk-name { font-size: 11px; background: rgba(0,0,0,0.85); color: #fff; padding: 2px 8px; border-radius: 4px; border: 1px solid var(--gold); margin-top: 4px; text-transform: uppercase; }
        
        .fog { background: rgba(0,0,0,0.92); border: 2px dashed #444; }
        .fog.selected { border-color: var(--gold); box-shadow: 0 0 15px var(--gold); }

        /* CONTROLES */
        .btn { background: var(--wine); border: 1px solid var(--gold); color: white; padding: 10px; width: 100%; cursor: pointer; font-family: 'Cinzel'; font-size: 10px; margin-bottom: 8px; border-radius: 4px; }
        .btn:hover { background: #700; }
        .panel-edit { background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px; border: 1px solid #333; margin-top: 10px; display: none; }
        label { font-size: 10px; color: var(--gold); display: block; margin-top: 12px; font-weight: bold; text-transform: uppercase; }
        input, select { width: 100%; background: #000; border: 1px solid #444; color: #fff; padding: 8px; margin-top: 5px; border-radius: 4px; font-family: 'Quicksand'; }
    </style>
</head>
<body>

<div id="scene-bar">
    <div id="scenes-list" style="display:flex; gap:8px;"></div>
    <div class="add-scene" onclick="createNewScene()" title="Nova Cena">+</div>
</div>

<div id="main">
    <div id="sidebar">
        <div class="brand">NEXUS // V15</div>
        <button class="btn" onclick="document.getElementById('map-in').click()">CARREGAR MAPA</button>
        <input type="file" id="map-in" style="display:none" onchange="loadMap(this)">
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
            <button class="btn" onclick="spawn('hero')">PERSONAGEM</button>
            <button class="btn" onclick="spawn('fog')">SOMBRA</button>
        </div>

        <div id="edit-panel" class="panel-edit">
            <div id="hero-ctrl">
                <label>NOME DO ALVO</label>
                <input type="text" id="in-name" oninput="applyUpdates()">
                
                <label>TAMANHO DO TOKEN</label>
                <input type="range" id="in-size" min="30" max="600" oninput="applyUpdates()">
                
                <label>VITALIDADE (ATUAL / MAX)</label>
                <div style="display:flex; gap:5px"><input type="number" id="in-cur" oninput="applyUpdates()"><input type="number" id="in-max" oninput="applyUpdates()"></div>
                
                <label>CONDIÇÃO VITAL</label>
                <select id="in-state" onchange="applyUpdates()">
                    <option value="normal">ESTÁVEL (NORMAL)</option>
                    <option value="injured">FERIDO (PULSAR)</option>
                    <option value="dead">MORTO (✕)</option>
                </select>
                
                <button class="btn" style="margin-top:15px; background:#333;" onclick="flipToken()">INVERTER LADO (F)</button>
            </div>

            <div id="fog-ctrl" style="display:none">
                <label>LARGURA / ALTURA</label>
                <div style="display:flex; gap:5px"><input type="number" id="in-w" oninput="applyFogUpdates()"><input type="number" id="in-h" oninput="applyFogUpdates()"></div>
                <label>OPACIDADE DA SOMBRA</label>
                <input type="range" id="in-op" min="0" max="100" oninput="applyFogUpdates()">
            </div>

            <hr style="margin:20px 0; border:0; border-top:1px solid #444">
            <button class="btn" style="background:#444" onclick="document.getElementById('art-in').click()">MUDAR ARTE</button>
            <input type="file" id="art-in" style="display:none" onchange="loadArt(this)">
            <button class="btn" style="background:#a00; border:none;" onclick="deleteActive()">REMOVER</button>
        </div>
    </div>
    <div id="viewport"></div>
</div>

<script>
    let scenes = {}, activeSceneId = null, activeToken = null, zIndexCounter = 100;
    let isPanning = false, isDragging = false;
    const viewport = document.getElementById('viewport');

    // --- SISTEMA DE CENAS ---
    function createNewScene() {
        const id = 's' + Date.now();
        const name = prompt("Nome da Cena:", "Cena " + (Object.keys(scenes).length + 1));
        if(!name) return;
        const layer = document.createElement('div');
        layer.className = 'world-layer';
        layer.innerHTML = `<img class="map-img" style="display:none; pointer-events:none; user-select:none;">`;
        viewport.appendChild(layer);
        scenes[id] = { name, cam: { x: 0, y: 0, zoom: 1 }, el: layer };
        renderSceneTabs();
        switchScene(id);
    }

    function renderSceneTabs() {
        const list = document.getElementById('scenes-list');
        list.innerHTML = '';
        Object.keys(scenes).forEach(id => {
            const btn = document.createElement('button');
            btn.className = 'scene-btn' + (id === activeSceneId ? ' active' : '');
            btn.innerText = scenes[id].name;
            btn.onclick = () => switchScene(id);
            list.appendChild(btn);
        });
    }

    function switchScene(id) {
        deselectAll();
        activeSceneId = id;
        document.querySelectorAll('.world-layer').forEach(l => l.classList.remove('active'));
        scenes[id].el.classList.add('active');
        renderSceneTabs();
        updateCameraTransform();
    }

    function updateCameraTransform() {
        if(!activeSceneId) return;
        const s = scenes[activeSceneId];
        s.el.style.transform = `translate(${s.cam.x}px, ${s.cam.y}px) scale(${s.cam.zoom})`;
    }

    // --- INPUTS E ZOOM ---
    viewport.onmousedown = e => {
        if(e.button >= 1) { isPanning = true; viewport.style.cursor = 'grabbing'; }
        else if(e.target === viewport) deselectAll();
    };

    window.addEventListener('mousemove', e => {
        if(isPanning && activeSceneId) {
            scenes[activeSceneId].cam.x += e.movementX;
            scenes[activeSceneId].cam.y += e.movementY;
            updateCameraTransform();
        }
        if(isDragging && activeToken && activeSceneId) {
            const s = scenes[activeSceneId];
            activeToken.style.left = (parseFloat(activeToken.style.left) + e.movementX / s.cam.zoom) + 'px';
            activeToken.style.top = (parseFloat(activeToken.style.top) + e.movementY / s.cam.zoom) + 'px';
        }
    });

    window.addEventListener('mouseup', () => {
        isPanning = false; isDragging = false;
        viewport.style.cursor = 'grab';
    });

    viewport.onwheel = e => {
        if(!activeSceneId) return;
        e.preventDefault();
        const s = scenes[activeSceneId];
        const delta = e.deltaY > 0 ? 0.9 : 1.1;
        const nextZoom = Math.min(Math.max(0.1, s.cam.zoom * delta), 5);
        const rect = viewport.getBoundingClientRect();
        const mx = e.clientX - rect.left;
        const my = e.clientY - rect.top;
        s.cam.x = mx - (mx - s.cam.x) * (nextZoom / s.cam.zoom);
        s.cam.y = my - (my - s.cam.y) * (nextZoom / s.cam.zoom);
        s.cam.zoom = nextZoom;
        updateCameraTransform();
    };

    // --- LÓGICA DE TOKENS ---
    function spawn(type) {
        if(!activeSceneId) return;
        const s = scenes[activeSceneId];
        const el = document.createElement('div');
        el.className = type === 'hero' ? 'token' : 'fog';
        const rect = viewport.getBoundingClientRect();
        el.style.left = `${(rect.width/2 - s.cam.x)/s.cam.zoom - 50}px`;
        el.style.top = `${(rect.height/2 - s.cam.y)/s.cam.zoom - 50}px`;

        if(type === 'hero') {
            el.innerHTML = `<div class="hp-bar"><div class="hp-fill"></div></div><div class="tk-art"></div><div class="tk-name">Novo Alvo</div>`;
            Object.assign(el.dataset, { cur: 20, max: 20, size: 100, state: 'normal', flip: 1 });
        } else {
            el.style.width = '200px'; el.style.height = '200px'; el.style.opacity = '1';
        }

        el.addEventListener('mousedown', (e) => {
            if(e.button !== 0) return;
            e.stopPropagation();
            selectToken(el);
            isDragging = true;
        });

        s.el.appendChild(el);
        selectToken(el);
        applyUpdates();
    }

    function selectToken(el) {
        deselectAll();
        activeToken = el;
        el.classList.add('selected');
        el.style.zIndex = ++zIndexCounter;
        document.getElementById('edit-panel').style.display = 'block';
        
        const isHero = el.classList.contains('token');
        document.getElementById('hero-ctrl').style.display = isHero ? 'block' : 'none';
        document.getElementById('fog-ctrl').style.display = isHero ? 'none' : 'block';

        if(isHero) {
            document.getElementById('in-name').value = el.querySelector('.tk-name').innerText;
            document.getElementById('in-size').value = el.dataset.size;
            document.getElementById('in-cur').value = el.dataset.cur;
            document.getElementById('in-max').value = el.dataset.max;
            document.getElementById('in-state').value = el.dataset.state;
        } else {
            document.getElementById('in-w').value = parseInt(el.style.width);
            document.getElementById('in-h').value = parseInt(el.style.height);
            document.getElementById('in-op').value = el.style.opacity * 100;
        }
    }

    function deselectAll() {
        activeToken = null;
        document.querySelectorAll('.token, .fog').forEach(t => t.classList.remove('selected'));
        document.getElementById('edit-panel').style.display = 'none';
    }

    function applyUpdates() {
        if(!activeToken || !activeToken.classList.contains('token')) return;
        const d = activeToken.dataset;
        d.size = document.getElementById('in-size').value;
        d.cur = document.getElementById('in-cur').value;
        d.max = document.getElementById('in-max').value;
        d.state = document.getElementById('in-state').value;
        
        const art = activeToken.querySelector('.tk-art');
        art.style.width = d.size + 'px';
        art.style.height = d.size + 'px';
        art.style.transform = `scaleX(${d.flip})`;
        
        // Aplica as classes de estado diretamente na arte
        art.className = 'tk-art state-' + d.state;
        
        activeToken.querySelector('.tk-name').innerText = document.getElementById('in-name').value;
        const pct = (d.cur / d.max) * 100;
        activeToken.querySelector('.hp-fill').style.width = Math.max(0, Math.min(100, pct)) + '%';
    }

    function applyFogUpdates() {
        if(!activeToken || activeToken.classList.contains('token')) return;
        activeToken.style.width = document.getElementById('in-w').value + 'px';
        activeToken.style.height = document.getElementById('in-h').value + 'px';
        activeToken.style.opacity = document.getElementById('in-op').value / 100;
    }

    // --- AUXILIARES ---
    function flipToken() { if(activeToken) { activeToken.dataset.flip *= -1; applyUpdates(); } }
    function deleteActive() { if(activeToken) { activeToken.remove(); deselectAll(); } }

    function loadMap(i) {
        if(i.files[0] && activeSceneId) {
            const r = new FileReader();
            r.onload = e => { const img = scenes[activeSceneId].el.querySelector('.map-img'); img.src = e.target.result; img.style.display = 'block'; };
            r.readAsDataURL(i.files[0]);
        }
    }

    function loadArt(i) {
        if(i.files[0] && activeToken) {
            const r = new FileReader();
            r.onload = e => activeToken.querySelector('.tk-art').style.backgroundImage = `url(${e.target.result})`;
            r.readAsDataURL(i.files[0]);
        }
    }

    window.onkeydown = e => {
        if(e.target.tagName === 'INPUT') return;
        if(e.key === 'Delete') deleteActive();
        if(e.key.toLowerCase() === 'f') flipToken();
    };

    viewport.oncontextmenu = e => e.preventDefault();
    createNewScene(); // Inicia o sistema
</script>
</body>
</html>
